---
title: 计算机组成原理 第五章 中央处理器
date: 2025-03-12 19:10:06
category: 计算机组成原理
tags:
- 计算机组成原理
- 笔记
description: 大的药来了。
cover: https://bu.dusays.com/2025/03/12/67d16c3e6dcfc.jpg
series: CS
---

> **🚥计算机组成原理 系列文章导航🚥**
>
> {% series CS %}

## 一、CPU 的功能和基本结构

**CPU 的功能**：

- **指令控制**：完成取指令、分析指令和执行指令的操作，即程序的顺序控制。
- **操作控制**：产生完成一条指令所需的操作信号，把各种操作信号送到相应的部件，从而控制这些部件按指令的要求正确执行。
- **时间控制**：严格控制各种操作信号的出现时间、持续时间及出现的时间顺序。
- **数据加工**：对数据进行算术和逻辑运算。
- **中断处理**：对运行过程中出现的异常情况和终端请求进行处理。

**CPU 的基本结构**：包括运算器和控制器两大部分

**运算器**：对数据进行加工。

- **算术逻辑单元**：主要功能是进行算术/逻辑运算。
- **通用寄存器组**：如 AX、BX、CX、DX、SP 等，用于存放操作数和各种地址信息等。SP 是堆栈指针，用于指示栈顶的地址。
- **暂存器**：用于暂存从主存读来的数据，这个数据不能存放在通用寄存器中，否则会破坏其原有内容。
- **累加寄存器**：它是一个通用寄存器，用于暂时存放 ALU 运算的结果信息，用于实现加法运算。
- **程序状态字寄存器**：PSW 中这些标志位参与并决定微操作的形成。
- **移位器**：对运算结果进行移位运算。
- **计数器**：控制乘除运算的操作步数。

**控制器**：协调并控制计算机各部件执行程序的指令序列，基本功能包括取指令、分析指令、执行指令。 每条指令的执行是由控制器发出的一组微操作实现的。

- **程序计数器**：用于指出下一条指令在主存中的存放地址。CPU 根据 PC 的内容去主存中取指令。因为程序指令中指令通常是顺序执行的，所以 PC 有自增功能
- **指令寄存器**：用于保存当前正在执行的那条指令。
- **指令译码器**：仅对操作字段进行译码，向控制器提供特点的操作信号。
- **微操作信号发生器**：根据 IR 的内容（指令）、PSW 的内容（状态信息）及时序信号，产生控制整个计算机系统所需的各种控制信号，其结构有组合逻辑型和存储逻辑型两种。
- **时序系统**：用于产生各种时序信号，它们都是由统一时钟（CLOCK）分频得到。
- **存储器地址寄存器**：用与存放所要访问的主存单元的地址。
- **存储器数据寄存器**：用于存放向主存写入的信息或从主存中读出的信息。

下图为 **CPU 内部单总线方式**下的结构，其中，橙色标注的为**用户可见的寄存器**，灰色标注的为**用户不可见的寄存器**。

<img src="https://bu.dusays.com/2025/03/15/67d574d372858.png" alt="image-20250314143944129" style="zoom: 50%;" />

## 二、指令执行过程

### 1.指令周期

**指令周期**：CPU 从主存中每取出并执行一条指令所需的全部时间。取值阶段完成取指令和分析指令的操作，也称**取指周期**；执行阶段完成执行指令的操作，也称**执行周期**。

**指令周期**常常用若干**机器周期**来表示，机器周期又叫 **CPU 周期**。

一个**机器周期**又包括若干**时钟周期**（也称为节拍、T 周期或 CPU 时钟周期，是 CPU 操作的**最基本单位**）。

![image-20250314150836418](https://bu.dusays.com/2025/03/15/67d574d8da289.png)

<img src="https://bu.dusays.com/2025/03/15/67d574de89a99.png" alt="image-20250314200226346" style="zoom: 80%;" />

每个指令周期内机器周期数可以不等，每个机器周期内的节拍数也可以不等。

四个工作周期都有 CPU 访存操作，只是访存的目的不同。取指周期是为了取指令，间址周期是为了取有效地址，执行周期是为了取操作数（当指令为访存指令时），中断周期是为了保存程序断点。

> **注意**：早期计算机通常采用机器周期、节拍和脉冲三级时序系统，一个指令可分为取指令、取操作数、执行、中断响应等工作周期，称为机器周期。现在的计算机已不再采用上述三级时序系统，机器周期的概念已逐渐消失，CPU 内部的定时信号就是时钟，一个时钟周期就是一个节拍。

### 2.指令周期的数据流

为了区分 CPU 的四个周期，在 CPU 内部可设置 4 个标志触发器（一般集成在 CU 内部），如下图：

<img src="https://bu.dusays.com/2025/03/15/67d57d7d78b02.png" alt="image-20250315211535512" style="zoom: 67%;" />

图中的 **FE（Fetch Execution）、IND（Indirect Addressing）、EX（Execute）、INT（Interrupt）** 分别对应取指、间址、执行、中断四个周期，并用 1 表示有效。

#### （1）取指周期

取指周期的任务是根据 PC 的内容从主存储器中取出指令代码并存放在 IR 中：

![image-20250315153549832](https://bu.dusays.com/2025/03/15/67d574e28e015.png)

![image-20250315153535261](https://bu.dusays.com/2025/03/15/67d574e5350dd.png)

#### （2）间址周期

间址周期的任务是取操作数的有效地址，需要先判断有没有间址周期，下面以一次间址为例：

![image-20250315152557064](https://bu.dusays.com/2025/03/15/67d574ea1a98c.png)

![image-20250315152225460](https://bu.dusays.com/2025/03/15/67d574edb821a.png)

间址周期的第一步中，IR 和 MDR 两者的内容是一样的，都可以提供指令字的地址字段。

间址周期的最后，将有效地址存放到 MDR 中，但也有的 CPU 会再将有效地址送到指令的地址码字段，记作：(MDR)->Ad(IR)。

#### （3）执行周期

执行周期的任务是取操作数，并根据 IR 中的指令字的操作码通过 ALU 操作产生执行结构。但不同指令的执行周期操作不同，没有统一数据流向。

#### （4）中断周期

中断周期的任务是处理中断请求，假设程序断点存入堆栈中，并用 SP 指示栈顶地址，而且进栈操作是先修改栈顶指针，后存入数据：

![image-20250315152625121](https://bu.dusays.com/2025/03/15/67d574f2b32e5.png)

![image-20250315152327605](https://bu.dusays.com/2025/03/15/67d574f741b91.png)

### 3.指令执行方案

#### （1）单周期处理器

**单周期处理器**对所有指令都选用相同的执行时间来完成。每条指令都在一个时钟周期内完成（CPI = 1），指令之间串行执行；指令周期取决于执行时间最长的指令的执行时间。

对于那些本来可以在更短时间内完成的指令，仍要在这个较长的周期内完成，会降低整个系统的运行速度。

#### （2）多周期处理器

**多周期处理器**对不同类型的指令选用不同的执行步骤，指令需要几个周期就为其分配几个周期，因此可选用不同个数的时钟周期来完成不同指令的执行过程（CPI > 1），不再要求所有指令占用相同的执行时间。多指令周期方案中指令之间仍是**串行**执行的。

#### （3）流水线处理器

**流水线处理器**采用指令直接并行执行的方案，力争在每个时钟周期完成一条指令的执行过程（只能在理想情况下才能达到，此时 CPI = 1）。这种方案通过在每个时钟周期内启动一条指令，尽量让多条指令同时运行，但各自出在不同的执行步骤中（因为指令在不同步骤中要用到的硬件会有所不同）。

## 三、数据通路的功能和基本结构

### 1.数据通路的功能和组成

CPU 可以视为由**数据通路**和**控制部件**两大部分组成。数据在指令执行过程中所经过的路径，包括路径上的部件，称为**数据通路**。数据通路由控制部件控制，控制部件根据每条指令功能的不同，生成对数据通路的控制信号。

组成数据通路的原件主要分为**组合逻辑元件**和**时序逻辑元件**两类：

- **组合逻辑元件**（操作元件）：任何适合产生的输出仅取决于当前的输入。不含存储信号的记忆单元，也不受时钟信号的控制，输入输出之间无反馈通路，数据是单向传输的。常用的有加法器、算术逻辑单元（ALU）、译码器、多路选择器、三态门等。
- **时序逻辑元件**（状态元件）：任何时候的输出不仅与该时刻的输入有关，还与该时刻以前的输入有关，因此时序电路必然包含存储信号的记忆单元。此外还必须在时钟节拍下工作。各类寄存器和存储器都属于时序逻辑单元。

### 2.数据通路的基本结构

#### （1）CPU 内部单总线方式

将 ALU 及所有寄存器都连接到一条内部总线上，称为单总线结构的数据通路。这种结构比较简单，但数据传输存在较多的冲突现象，性能较低。

区分内部总线与系统总线:

- **内部总线**：是指同一台计算机系统的各部件，如 CPU、内存、寄存器及运算部件之间的总线。
- **系统总线**：是指同一台计算机系统的各部件，如 CPU、内存、通道和各类 I/O 接口间互相连接的总线。 

> **注意**：单周期处理器（CPI = 1）不能采用单总线方式，因为单总线将所有寄存器都连接到一条公共总线上，一个时钟周期内只允许一次操作，无法完成一条指令的全部操作。

#### （2）CPU 内部多总线方式

CPU 内部有两条或更多的总线时，构成双总线结构或多总线结构。采用多总线结构可以同时在多个总线上传送不同的数据，提升效率。

#### （3）专用数据通路方式

根据指令执行过程中的数据和地址的流动方向安排连接线路（只要两个寄存器之间需要有数据流动，就专门建立一个连线）。性能高，基本不存在数据冲突，但结构复杂、硬件量大，不易实现。

此外，如果直接用导线连接，会导致多个寄存器同时并且一直传输数据。

- 解决方式 1：使用多路选择器根据控制信号选择一路输出。
- 解决方法 2：使用三态门控制每一路是否输出。

### 3.数据通路的操作举例

总线是一组共享的传输信号线，它不能存储信息，在任一时刻也只能有一个部件把信息送到总线上。下面以单总线数据通路为例介绍常见操作的流程及控制信号：

<img src="https://bu.dusays.com/2025/03/15/67d574fe4a4de.png" alt="image-20250315195047037" style="zoom: 67%;" />

> **单总线结构下 ALU 中设置暂存器的原因**：
>
> 单总线数据通路中，每一时刻总线上只有一个数据有效。因为 ALU 是一个没有存储功能的组合逻辑元件，在其执行运算时必须保持两个输入端同时有效，所以先将一个操作数经内部总线送入暂存器 Y 保存。Y 的内容在 ALU 的左输入端始终有效，再将另一个操作数经内部总线直接送到 ALU 的右端。ALU 输出端也不能直接与总线相连，否则其输出会通过总线反馈到输入端，影响运算结果，因此将运算结果暂存在寄存器 Z 中。

**（1）通用寄存器之间传送数据**

以 PC 为例，将 PC 的内容送至 MAR：

|   微操作    |              控制信号               |
| :---------: | :---------------------------------: |
| (PC) -> MAR | PCout 和 MARin 有效，PC 内容 -> MAR |

**（2）从主存读取数据**

以 CPU 从主存中取指令为例：

|             微操作             |                   控制信号                    |
| :----------------------------: | :-------------------------------------------: |
|          (PC) -> MAR           |   PCout 和 MARin 有效，现行指令地址 -> MAR    |
| MEM(MAR) ->MDR, (PC) + 1 -> PC | MDRinE 有效，CU 发出读命令，取出指令后 PC + 1 |
|          (MDR) -> IR           |      MDRout 和 IRin 有效，现行指令 -> IR      |

**（3）将数据写入主存**

以将寄存器 R1 的内容写入寄存器 R2 所指的主存单元为例：

|     微操作      |          控制信号           |
| :-------------: | :-------------------------: |
|   (R1) -> MDR   |     R1out 和 MDRin 有效     |
|   (R2) -> MAR   |     R2out 和 MARin有效      |
| MDR -> MEM(MAR) | MDRoutE 有效，CU 发出写命令 |

**（4）执行算术或逻辑运算**

以加法指令 ADD ACC，R 为例：

|      微操作      |                       控制信号                        |
| :--------------: | :---------------------------------------------------: |
|    (R1) -> Y     |            R1out 和 Yin 有效，操作数 -> Y             |
| (ACC) + (Y) -> Z | ACCout 和 ALUin 有效，CU 向 ALU 发出加命令，结果 -> Z |
|    (Z) -> ACC    |            Zout 和 ACCin 有效，结果 -> ACC            |

以上三步不能同时执行，否则会引起总线冲突，因此该操作需要三个时钟周期。

**（5）修改程序计数器的值**

以 JMP addr（addr 为目标转移地址）实现将 IR 中的地址字段写入 PC，完成该操作的流程及控制信号为例：

|    微操作    |      控制信号      |
| :----------: | :----------------: |
| Ad(IR) -> PC | IRout 和 PCin 有效 |

## 四、控制器的功能和工作原理

根据控制器产生微操作控制信号的方式的不同，控制器可分为**硬布线控制器**和**微程序控制器**。

### 1.硬布线控制器

**硬布线控制器**：由复杂的组合逻辑门电路和触发器构成，也称**组合逻辑控制器**。

根据指令操作码、目前的机器周期、节拍信号、机器状态条件，即可确定现在这个节拍下应该发出哪些微命令。

![image-20250316152012621](https://bu.dusays.com/2025/03/17/67d7ba9772d4b.png)

设计步骤：

1. 分析每个阶段的微操作序列（取指、间址、执行、中断四个阶段）。
2. 选择 CPU 的控制方式（采用定长机器周期还是不定长机器周期，每个机器周期安排几个节拍）。
3. 安排微操作时序（如何在有限的节拍内完成整个机器周期内的所有微操作）。
4. 电路设计（确定每个微操作命令的逻辑表达式并用电路实现）。

安排微操作时序的原则：

- 原则一：微操作的先和顺序不得随意更改。
- 原则二：被控对象不同的微操作尽量安排在一个节拍内完成。
- 原则三：占用时间较短的微操作尽量安排在一个节拍内完成，并允许有先后顺序。

> **注意**：从主存取数据，用时较长，因此必须一个时钟周期才能保证微操作的完成；CPU 内部寄存器之间的数据传送，速度很快，因此在一个时钟周期内可以紧接着完成。

**硬布线控制器的特点**：指令越多，设计和实现就越复杂，因此一般用于 RISC，如果扩充一条新的指令，则控制器的设计就需要大改，因此扩充指令较困难。由于使用纯硬件实现控制，因此执行速度很快。微操作控制信号由组合逻辑电路即时产生。

### 2.微程序控制器

#### （1）微程序控制的基本概念

**微程序控制器**：采用存储逻辑实现，将微操作信号代码化，使每条机器指令转化成为一段微程序并存入一个专门的存储器（控制存储器）中，微操作控制信号由微指令产生。

微程序控制器的设计采用**存储程序**的思想，CPU 出厂前将所有指令的微程序存入**控制器存储器**中。

- **程序**：由指令序列组成。
- **微程序**：由微指令序列组成，每一种指令对应一个微程序。

- **指令**：对程序执行步骤的描述。
- **微指令**：对指令执行步骤的描述。

- **微命令**：在微程序控制的计算机中，控制部件向执行部件发出的各种控制命令称为微命令，是构成控制序列的**最小单元**。
- **微操作**：执行部件收到微命令后所进行的操作称为微操作。

微程序和指令是一一对应的，微命令和微操作是一一对应的。

> **注意**：硬布线控制器中也有微命令与微操作的概念，并非微程序控制器的专有概念。

#### （2）微程序控制器的组成与结构

![image-20250317140031212](https://bu.dusays.com/2025/03/17/67d8073bd9281.png)

**微周期**：从控制存储器中取出并执行一条微指令所需的全部时间，通常为一个时钟周期。

微指令是若干微命令的集合，一条微指令通常包含两大部分信息：

- **操作控制字段**：也称微操作码字段，用于产生某一步操作所需的各种操作控制信号。
- **顺序控制字段**：也称微地址码字段，用于控制产生下一条要执行的微指令地址。

**寄存器的区分**：

- **地址寄存器（MAR）**：存放主存的读/写地址。
- **微指令地址寄存器（uPC 或 CMAR）**：存放待执行的微指令在控制存储器中的微地址。
- **指令寄存器（IR）**：存放从主存中读出的指令。
- **微指令寄存器（uIR 或 CMDR）**：存放从控制存储器中读出的微指令。

#### （3）微程序控制器的工作原理

![image-20250317141126644](https://bu.dusays.com/2025/03/17/67d807413a26e.png)

取指周期的微指令序列固定从 #0 开始存放，执行周期的微指令序列的存放根据指令操作码确定。

每执行完一条微指令，会根据微指令上的微地址码字段去执行下一条微指令。但还会结合指令地址码的寻址特征判断是否跳过间址周期、结合中断信号判断是否进入中断周期。

> **注意 1**：所有指令的取指周期、间址周期、中断周期所对应的微指令序列通常是公用的，执行周期的微指令序列各不相同。故如果某指令系统中有 n 条机器指令，则 CM 中微程序（段）的个数至少是 n + 1 个。

> **注意 2**：物理上，取指周期、执行周期看起来像是两个微程序，但逻辑上应该把它们看作一个整体。因此，一条指令对应一个微程序的说法是正确的（出题老头左右脑互搏魅力时刻）。

### 3.微指令的设计

微命令与微操作一一对应，一个微命令对应一根输出线。有的微命令可以并行执行，因此一条微指令可以包含多个微命令。

微命令有**相容性**和**互斥性**之分，相容性微命令是指可以同时出现、共同完成某一些微操作的命令，互斥性微命令是指在机器中不允许同时出现的微命令。

#### （1）微指令的格式

**水平型微指令**：一条微指令能够定义多个可并行的微程序。

![image-20250317150140164](https://bu.dusays.com/2025/03/17/67d807465e36f.png)

优点：微程序短，执行速度快。

缺点：微指令长，编写微程序比较麻烦。

**垂直型微指令**：一条微指令只能定义一个微命令，由微操作码字段规定具体功能。

![image-20250317150337946](https://bu.dusays.com/2025/03/17/67d80749e35e3.png)

优点：微指令短、简单、规整，便于编写微程序。

缺点：微程序长，执行速度慢，工作效率低。

**混合型微指令**：在垂直型的基础上增加一些不太复杂的并行操作。微指令较短，仍便于编写；微程序也不长，执行速度加快。

#### （2）微指令的编码方式

从编码方式看，直接编码、字段直接编码和字段间接编码都属于水平型微指令。

**直接编码（直接控制）方式**

在微指令的操作控制字段中，每一位代表一个微操作命令，某位为 1，表示该控制信号有效。

<img src="https://bu.dusays.com/2025/03/17/67d8074ddac68.png" alt="image-20250317151741111" style="zoom:80%;" />

优点：简单、直观，执行速度快，操作并行性好。

缺点：微指令字长过长，n 个微命令就要求微指令的操作字段有 n 位，造成控存容量极大。

**字段直接编码方式**

将微指令的控制字段分成若干段，每段经译码后发出控制信号。

<img src="https://bu.dusays.com/2025/03/17/67d80751b5ac7.png" alt="image-20250317152427897" style="zoom:80%;" />

微命令字段分段的原则：

- 互斥性微命令分在同一段内，相容性微命令分在不同段内。
- 每个小段中包含的信息位不能太多，否则将增加译码线路的复杂性和译码时间。
- 一般每个小段还要留出一个状态，表示本字段不发出任何微命令。因此，当某字段的长度为 3 位时，最多只能表示 7 个互斥的微命令，通常用全 0 表示不操作。

优点：可以缩短微指令字长。

缺点：要通过译码电路后再发出微命令，因此比直接编码方式慢。

**字段间接编码方式**

一个字段的某些微命令需由另一个字段中的某些微命令来解释（经过两次译码），由于不是靠字段直接译码发出的微命令，故称为字段间接编码，又称隐式编码。

<img src="https://bu.dusays.com/2025/03/17/67d807582e2f1.png" alt="image-20250317153149193" style="zoom: 80%;" />

优点：可以进一步缩短微指令字长。

缺点：削弱了微指令的并行控制能力，故通常作为字段直接编码方式的一种辅助手段。

#### （3）微指令的地址形成方式

1. 由微指令的后继地址字段（也称下地址字段）指出。在微指令格式中设置一个后继地址字段，由微指令的后继地址字段直接指出后继微指令的地址，这种方式也称**断定方式**。
2. 根据机器指令的操作码形成。当机器指令取自指令寄存器后，微指令的地址由操作码经微地址形成部件形成，该部件输出的是对应机器指令微程序的首地址。
3. 增量计数法。即 (uPC) + 1 -> uPC，适用于后继微指令地址是连续的情况。
4. 根据各种标志决定下一条微指令分支转移的地址。
5. 由硬件直接产生微程序入口地址。电源加电后，第一条微指令的地址可由专门的硬件电路产生，并送至 uPC，这个地址即为取指周期微程序的入口地址。

### 4.微程序控制单元的设计

![image-20250317192727508](https://bu.dusays.com/2025/03/17/67d8075c37032.png)

设计步骤：

<img src="https://bu.dusays.com/2025/03/17/67d80ea2f02d4.png" alt="image-20250317193913917" style="zoom:80%;" />

微程序设计分类：

- **静态**：微程序无需改变，采用 ROM。
- **动态**：通过改变微指令和微程序改变机器指令，有利于仿真，采用 EPROM。

毫微程序设计：用毫微程序解释微程序（计算机套娃原理）。

### 5.两种控制器对比

**硬布线控制器**：

优点：控制器的速度取决于电路延迟，所以速度快。

缺点：将控制部件视为专门产生固定时序控制信号的逻辑电路，所以把用最少元件和取得最高速度作为设计目标，一旦设计完成，就不可能通过其他额外修改来添加最新功能。

**微程序控制器**：

优点：具有规整性、灵活性和可维护性。

缺点：因为微程序控制器采用了存储程序原理，所以每条指令都要从控制存储器中取一次，影响速度。

|    对比项    |                         硬布线控制器                         |                         微程序控制器                         |
| :----------: | :----------------------------------------------------------: | :----------------------------------------------------------: |
| **工作原理** | 微操作控制信号由组合逻辑电路根据当前的指令码、状态和时序及时产生 | 微操作控制信号以微程序的形式存放在控制存储器中，执行指令时读出即可 |
| **执行速度** |                              快                              |                              慢                              |
|  **规整性**  |                         繁琐、不规整                         |                            较规整                            |
| **应用场合** |                           RISC CPU                           |                           CISC CPU                           |
| **易扩充性** |                         扩充修改困难                         |                          易扩充修改                          |

## 五、指令流水线
